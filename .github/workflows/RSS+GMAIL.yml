name: RSS+GMAIL

on:
  schedule:
    # Beijing 00:00 = UTC 16:00 (previous day)
    - cron: "0 16 * * *"
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      RESEARCH_PROMPT: ${{ secrets.RESEARCH_PROMPT }}
      OPENALEX_API_KEY: ${{ secrets.OPENALEX_API_KEY }}
      POLITE_POOL_EMAIL: ${{ secrets.POLITE_POOL_EMAIL }}
      PAPER_FEEDDER_MCP_OPML: feeds/RSS_official.opml
      PAPER_FEEDDER_MCP_USER_AGENT: paper-feedder-mcp/2.0
      RSS_TIMEOUT: "30"
      RSS_MAX_CONCURRENT: "10"
      GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
      GMAIL_CREDENTIALS_JSON: ${{ secrets.GMAIL_CREDENTIALS_JSON }}
      GMAIL_SENDER_FILTER: ${{ secrets.GMAIL_SENDER_FILTER }}
      GMAIL_SENDER_MAP_JSON: ${{ secrets.GMAIL_SENDER_MAP_JSON }}
      GMAIL_TRASH_AFTER_PROCESS: "true"
      GMAIL_VERIFY_TRASH_AFTER_PROCESS: "true"
      GMAIL_VERIFY_TRASH_LIMIT: "50"
      GMAIL_TOKEN_FILE: feeds/token.json
      GMAIL_CREDENTIALS_FILE: feeds/credentials.json
      ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
      ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
      ZOTERO_LIBRARY_TYPE: user

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout zotero-mcp
        uses: actions/checkout@v4
        with:
          repository: liuchzzyy/zotero-mcp
          path: zotero-mcp

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync
          uv pip install ./zotero-mcp

      - name: Compute dates
        shell: bash
        run: |
          echo "RUN_DATE=$(TZ=Asia/Shanghai date +%Y_%m_%d)" >> $GITHUB_ENV
          echo "SINCE_DATE=$(TZ=Asia/Shanghai date -d '15 days ago' +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Prepare output dir
        run: mkdir -p output

      - name: RSS pipeline (15 days)
        id: rss
        shell: bash
        run: |
          START_TIME=$(date +%s)
          uv run paper-feedder-mcp fetch --source rss --since "$SINCE_DATE" --output output/rss_raw.json
          uv run paper-feedder-mcp filter --input output/rss_raw.json --output output/rss_filtered.json
          uv run paper-feedder-mcp filter --input output/rss_filtered.json --output output/rss_ai_filtered.json --ai
          uv run paper-feedder-mcp enrich --input output/rss_ai_filtered.json --output output/rss_enriched.json --source all --concurrency 5
          uv run paper-feedder-mcp export --input output/rss_enriched.json --output "output/${RUN_DATE}_RSS_ZOTERO.json" --format zotero
          END_TIME=$(date +%s)

          # Extract counts from output files
          RSS_RAW=$(python3 -c "import json; print(len(json.load(open('output/rss_raw.json'))))" 2>/dev/null || echo "0")
          RSS_FILTERED=$(python3 -c "import json; print(len(json.load(open('output/rss_ai_filtered.json'))))" 2>/dev/null || echo "0")
          RSS_ENRICHED=$(python3 -c "import json; print(len(json.load(open('output/rss_enriched.json'))))" 2>/dev/null || echo "0")

          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
          echo "raw=$RSS_RAW" >> $GITHUB_OUTPUT
          echo "filtered=$RSS_FILTERED" >> $GITHUB_OUTPUT
          echo "enriched=$RSS_ENRICHED" >> $GITHUB_OUTPUT

      - name: Gmail pipeline (15 days)
        id: gmail
        if: ${{ !cancelled() }}
        shell: bash
        run: |
          START_TIME=$(date +%s)
          uv run paper-feedder-mcp fetch --source gmail --since "$SINCE_DATE" --output output/gmail_raw.json
          uv run paper-feedder-mcp filter --input output/gmail_raw.json --output output/gmail_filtered.json
          uv run paper-feedder-mcp filter --input output/gmail_filtered.json --output output/gmail_ai_filtered.json --ai
          uv run paper-feedder-mcp enrich --input output/gmail_ai_filtered.json --output output/gmail_enriched.json --source all --concurrency 5
          uv run paper-feedder-mcp export --input output/gmail_enriched.json --output "output/${RUN_DATE}_GMAIL_ZOTERO.json" --format zotero
          END_TIME=$(date +%s)

          # Extract counts from output files
          GMAIL_RAW=$(python3 -c "import json; print(len(json.load(open('output/gmail_raw.json'))))" 2>/dev/null || echo "0")
          GMAIL_FILTERED=$(python3 -c "import json; print(len(json.load(open('output/gmail_ai_filtered.json'))))" 2>/dev/null || echo "0")
          GMAIL_ENRICHED=$(python3 -c "import json; print(len(json.load(open('output/gmail_enriched.json'))))" 2>/dev/null || echo "0")

          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
          echo "raw=$GMAIL_RAW" >> $GITHUB_OUTPUT
          echo "filtered=$GMAIL_FILTERED" >> $GITHUB_OUTPUT
          echo "enriched=$GMAIL_ENRICHED" >> $GITHUB_OUTPUT

      - name: Generate Summary
        if: always()
        shell: bash
        run: |
          echo "## RSS+GMAIL Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Date | ${RUN_DATE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Since | ${SINCE_DATE} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### RSS Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fetched | ${{ steps.rss.outputs.raw || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| After filter | ${{ steps.rss.outputs.filtered || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Enriched | ${{ steps.rss.outputs.enriched || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${{ steps.rss.outputs.duration || '—' }}s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Gmail Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fetched | ${{ steps.gmail.outputs.raw || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| After filter | ${{ steps.gmail.outputs.filtered || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Enriched | ${{ steps.gmail.outputs.enriched || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${{ steps.gmail.outputs.duration || '—' }}s |" >> $GITHUB_STEP_SUMMARY

      - name: Clean output
        if: always()
        run: uv run paper-feedder-mcp delete --output-dir output

      - name: Notify on failure
        if: failure() && github.event_name == 'schedule'
        run: |
          echo "::warning::RSS+GMAIL workflow failed. Check the logs for details."
