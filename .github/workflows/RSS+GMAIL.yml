name: RSS+GMAIL

on:
  schedule:
    # Beijing 00:00 = UTC 16:00 (previous day)
    - cron: "0 16 * * *"
  workflow_dispatch:
    inputs:
      since_days:
        description: "Lookback window in days"
        required: false
        default: "15"
      zotero_mcp_repo:
        description: "zotero-mcp repository (owner/repo)"
        required: false
        default: "liuchzzyy/zotero-mcp"
      zotero_mcp_ref:
        description: "zotero-mcp branch/tag/SHA"
        required: false
        default: "main"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rss:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      RESEARCH_PROMPT: ${{ secrets.RESEARCH_PROMPT }}
      OPENALEX_API_KEY: ${{ secrets.OPENALEX_API_KEY }}
      POLITE_POOL_EMAIL: ${{ secrets.POLITE_POOL_EMAIL }}
      PAPER_FEEDDER_MCP_OPML: feeds/RSS_official.opml
      PAPER_FEEDDER_MCP_USER_AGENT: feedder-mcp/2.0
      RSS_TIMEOUT: "30"
      RSS_MAX_CONCURRENT: "10"
      GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
      GMAIL_CREDENTIALS_JSON: ${{ secrets.GMAIL_CREDENTIALS_JSON }}
      GMAIL_SENDER_FILTER: ${{ secrets.GMAIL_SENDER_FILTER }}
      GMAIL_SENDER_MAP_JSON: ${{ secrets.GMAIL_SENDER_MAP_JSON }}
      GMAIL_TRASH_AFTER_PROCESS: "true"
      GMAIL_VERIFY_TRASH_AFTER_PROCESS: "true"
      GMAIL_VERIFY_TRASH_LIMIT: "50"
      GMAIL_TOKEN_FILE: feeds/token.json
      GMAIL_CREDENTIALS_FILE: feeds/credentials.json
      ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
      ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
      ZOTERO_LIBRARY_TYPE: user
      TARGET_COLLECTION: ${{ secrets.TARGET_COLLECTION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout zotero-mcp
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.zotero_mcp_repo || vars.ZOTERO_MCP_REPO || 'liuchzzyy/zotero-mcp' }}
          ref: ${{ github.event.inputs.zotero_mcp_ref || vars.ZOTERO_MCP_REF || 'main' }}
          path: zotero-mcp

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: Install dependencies
        run: |
          uv sync
          uv pip install ./zotero-mcp

      - name: Compute dates
        shell: bash
        run: |
          SINCE_DAYS="${{ github.event.inputs.since_days || vars.SINCE_DAYS || '15' }}"
          if ! [[ "${SINCE_DAYS}" =~ ^[0-9]+$ ]]; then
            echo "Invalid SINCE_DAYS: ${SINCE_DAYS}" >&2
            exit 1
          fi
          SINCE_DATE="$(TZ=Asia/Shanghai date -d "${SINCE_DAYS} days ago" +%Y-%m-%d)"
          echo "RUN_DATE=$(TZ=Asia/Shanghai date +%Y-%m-%d)" >> $GITHUB_ENV
          echo "RUN_DIR=output/$(TZ=Asia/Shanghai date +%Y-%m-%d)" >> $GITHUB_ENV
          echo "SINCE_DAYS=${SINCE_DAYS}" >> $GITHUB_ENV
          echo "SINCE_DATE=${SINCE_DATE}" >> $GITHUB_ENV

      - name: Prepare output dir
        run: mkdir -p "$RUN_DIR"

      - name: RSS pipeline (${{ github.event.inputs.since_days || vars.SINCE_DAYS || '15' }} days)
        id: rss
        shell: bash
        run: |
          START_TIME=$(date +%s)
          RAW_PATH="$RUN_DIR/rss_fetched_papers.json"
          SEMANTIC_FILTERED_PATH="$RUN_DIR/rss_semantic_filtered_papers.json"
          ENRICHED_PATH="$RUN_DIR/rss_enriched_papers.json"
          FINAL_JSON_PATH="$RUN_DIR/rss_exported_papers.json"
          ZOTERO_PATH="$RUN_DIR/rss_zotero_export.json"

          uv run feedder-mcp fetch --source rss --since "$SINCE_DATE" --output "$RAW_PATH"
          RSS_RAW=$(python3 -c "import json; print(len(json.load(open('$RAW_PATH'))))" 2>/dev/null || echo "0")

          if [ "$RSS_RAW" -gt 0 ]; then
            uv run feedder-mcp filter --input "$RAW_PATH" --output "$SEMANTIC_FILTERED_PATH" --semantic-filter
            uv run feedder-mcp enrich --input "$SEMANTIC_FILTERED_PATH" --output "$ENRICHED_PATH" --source all --concurrency 5
            uv run feedder-mcp export --input "$ENRICHED_PATH" --output "$FINAL_JSON_PATH" --format json
            if [ -n "${TARGET_COLLECTION}" ]; then
              uv run feedder-mcp export --input "$ENRICHED_PATH" --output "$ZOTERO_PATH" --format zotero --collection "${TARGET_COLLECTION}"
            else
              uv run feedder-mcp export --input "$ENRICHED_PATH" --output "$ZOTERO_PATH" --format zotero
            fi
          else
            echo "No RSS papers fetched. Skipping filter/enrich/export."
            echo "[]" > "$SEMANTIC_FILTERED_PATH"
            echo "[]" > "$ENRICHED_PATH"
            echo "[]" > "$FINAL_JSON_PATH"
          fi
          END_TIME=$(date +%s)

          # Extract counts from output files
          RSS_FILTERED=$(python3 -c "import json; print(len(json.load(open('$SEMANTIC_FILTERED_PATH'))))" 2>/dev/null || echo "0")
          RSS_ENRICHED=$(python3 -c "import json; print(len(json.load(open('$ENRICHED_PATH'))))" 2>/dev/null || echo "0")
          RSS_ZOTERO_CREATED=$(python3 -c "import json; print(json.load(open('$ZOTERO_PATH')).get('success_count',0))" 2>/dev/null || echo "0")
          RSS_ZOTERO_SKIPPED=$(python3 -c "import json; print(json.load(open('$ZOTERO_PATH')).get('skipped_count',0))" 2>/dev/null || echo "0")
          RSS_ZOTERO_FAILED=$(python3 -c "import json; print(len(json.load(open('$ZOTERO_PATH')).get('failures',[])))" 2>/dev/null || echo "0")

          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
          echo "raw=$RSS_RAW" >> $GITHUB_OUTPUT
          echo "filtered=$RSS_FILTERED" >> $GITHUB_OUTPUT
          echo "enriched=$RSS_ENRICHED" >> $GITHUB_OUTPUT
          echo "zotero_created=$RSS_ZOTERO_CREATED" >> $GITHUB_OUTPUT
          echo "zotero_skipped=$RSS_ZOTERO_SKIPPED" >> $GITHUB_OUTPUT
          echo "zotero_failed=$RSS_ZOTERO_FAILED" >> $GITHUB_OUTPUT

      - name: RSS Summary
        if: always()
        shell: bash
        run: |
          echo "## RSS Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Date | ${RUN_DATE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Output dir | ${RUN_DIR} |" >> $GITHUB_STEP_SUMMARY
          echo "| Since days | ${SINCE_DAYS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Since | ${SINCE_DATE} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fetched | ${{ steps.rss.outputs.raw || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| After filter | ${{ steps.rss.outputs.filtered || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Enriched | ${{ steps.rss.outputs.enriched || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Zotero created | ${{ steps.rss.outputs.zotero_created || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Zotero skipped | ${{ steps.rss.outputs.zotero_skipped || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Zotero failed | ${{ steps.rss.outputs.zotero_failed || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${{ steps.rss.outputs.duration || '—' }}s |" >> $GITHUB_STEP_SUMMARY

      - name: Upload RSS artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rss-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ env.RUN_DIR }}
          if-no-files-found: warn
          retention-days: 14

      - name: Notify on failure
        if: failure() && github.event_name == 'schedule'
        run: |
          echo "::warning::RSS workflow failed. Check the logs for details."

  gmail:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      RESEARCH_PROMPT: ${{ secrets.RESEARCH_PROMPT }}
      OPENALEX_API_KEY: ${{ secrets.OPENALEX_API_KEY }}
      POLITE_POOL_EMAIL: ${{ secrets.POLITE_POOL_EMAIL }}
      PAPER_FEEDDER_MCP_OPML: feeds/RSS_official.opml
      PAPER_FEEDDER_MCP_USER_AGENT: feedder-mcp/2.0
      RSS_TIMEOUT: "30"
      RSS_MAX_CONCURRENT: "10"
      GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
      GMAIL_CREDENTIALS_JSON: ${{ secrets.GMAIL_CREDENTIALS_JSON }}
      GMAIL_SENDER_FILTER: ${{ secrets.GMAIL_SENDER_FILTER }}
      GMAIL_SENDER_MAP_JSON: ${{ secrets.GMAIL_SENDER_MAP_JSON }}
      GMAIL_TRASH_AFTER_PROCESS: "true"
      GMAIL_VERIFY_TRASH_AFTER_PROCESS: "true"
      GMAIL_VERIFY_TRASH_LIMIT: "50"
      GMAIL_TOKEN_FILE: feeds/token.json
      GMAIL_CREDENTIALS_FILE: feeds/credentials.json
      ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
      ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
      ZOTERO_LIBRARY_TYPE: user
      TARGET_COLLECTION: ${{ secrets.TARGET_COLLECTION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout zotero-mcp
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.zotero_mcp_repo || vars.ZOTERO_MCP_REPO || 'liuchzzyy/zotero-mcp' }}
          ref: ${{ github.event.inputs.zotero_mcp_ref || vars.ZOTERO_MCP_REF || 'main' }}
          path: zotero-mcp

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: Install dependencies
        run: |
          uv sync
          uv pip install ./zotero-mcp

      - name: Compute dates
        shell: bash
        run: |
          SINCE_DAYS="${{ github.event.inputs.since_days || vars.SINCE_DAYS || '15' }}"
          if ! [[ "${SINCE_DAYS}" =~ ^[0-9]+$ ]]; then
            echo "Invalid SINCE_DAYS: ${SINCE_DAYS}" >&2
            exit 1
          fi
          SINCE_DATE="$(TZ=Asia/Shanghai date -d "${SINCE_DAYS} days ago" +%Y-%m-%d)"
          echo "RUN_DATE=$(TZ=Asia/Shanghai date +%Y-%m-%d)" >> $GITHUB_ENV
          echo "RUN_DIR=output/$(TZ=Asia/Shanghai date +%Y-%m-%d)" >> $GITHUB_ENV
          echo "SINCE_DAYS=${SINCE_DAYS}" >> $GITHUB_ENV
          echo "SINCE_DATE=${SINCE_DATE}" >> $GITHUB_ENV

      - name: Prepare output dir
        run: mkdir -p "$RUN_DIR"

      - name: Gmail pipeline (${{ github.event.inputs.since_days || vars.SINCE_DAYS || '15' }} days)
        id: gmail
        shell: bash
        run: |
          START_TIME=$(date +%s)
          RAW_PATH="$RUN_DIR/gmail_fetched_papers.json"
          SEMANTIC_FILTERED_PATH="$RUN_DIR/gmail_semantic_filtered_papers.json"
          ENRICHED_PATH="$RUN_DIR/gmail_enriched_papers.json"
          FINAL_JSON_PATH="$RUN_DIR/gmail_exported_papers.json"
          ZOTERO_PATH="$RUN_DIR/gmail_zotero_export.json"

          uv run feedder-mcp fetch --source gmail --since "$SINCE_DATE" --output "$RAW_PATH"
          GMAIL_RAW=$(python3 -c "import json; print(len(json.load(open('$RAW_PATH'))))" 2>/dev/null || echo "0")

          if [ "$GMAIL_RAW" -gt 0 ]; then
            uv run feedder-mcp filter --input "$RAW_PATH" --output "$SEMANTIC_FILTERED_PATH" --semantic-filter
            uv run feedder-mcp enrich --input "$SEMANTIC_FILTERED_PATH" --output "$ENRICHED_PATH" --source all --concurrency 5
            uv run feedder-mcp export --input "$ENRICHED_PATH" --output "$FINAL_JSON_PATH" --format json
            if [ -n "${TARGET_COLLECTION}" ]; then
              uv run feedder-mcp export --input "$ENRICHED_PATH" --output "$ZOTERO_PATH" --format zotero --collection "${TARGET_COLLECTION}"
            else
              uv run feedder-mcp export --input "$ENRICHED_PATH" --output "$ZOTERO_PATH" --format zotero
            fi
          else
            echo "No Gmail papers fetched. Skipping filter/enrich/export."
            echo "[]" > "$SEMANTIC_FILTERED_PATH"
            echo "[]" > "$ENRICHED_PATH"
            echo "[]" > "$FINAL_JSON_PATH"
          fi
          END_TIME=$(date +%s)

          GMAIL_FILTERED=$(python3 -c "import json; print(len(json.load(open('$SEMANTIC_FILTERED_PATH'))))" 2>/dev/null || echo "0")
          GMAIL_ENRICHED=$(python3 -c "import json; print(len(json.load(open('$ENRICHED_PATH'))))" 2>/dev/null || echo "0")
          GMAIL_ZOTERO_CREATED=$(python3 -c "import json; print(json.load(open('$ZOTERO_PATH')).get('success_count',0))" 2>/dev/null || echo "0")
          GMAIL_ZOTERO_SKIPPED=$(python3 -c "import json; print(json.load(open('$ZOTERO_PATH')).get('skipped_count',0))" 2>/dev/null || echo "0")
          GMAIL_ZOTERO_FAILED=$(python3 -c "import json; print(len(json.load(open('$ZOTERO_PATH')).get('failures',[])))" 2>/dev/null || echo "0")

          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
          echo "raw=$GMAIL_RAW" >> $GITHUB_OUTPUT
          echo "filtered=$GMAIL_FILTERED" >> $GITHUB_OUTPUT
          echo "enriched=$GMAIL_ENRICHED" >> $GITHUB_OUTPUT
          echo "zotero_created=$GMAIL_ZOTERO_CREATED" >> $GITHUB_OUTPUT
          echo "zotero_skipped=$GMAIL_ZOTERO_SKIPPED" >> $GITHUB_OUTPUT
          echo "zotero_failed=$GMAIL_ZOTERO_FAILED" >> $GITHUB_OUTPUT

      - name: Gmail Summary
        if: always()
        shell: bash
        run: |
          echo "## Gmail Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Date | ${RUN_DATE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Output dir | ${RUN_DIR} |" >> $GITHUB_STEP_SUMMARY
          echo "| Since days | ${SINCE_DAYS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Since | ${SINCE_DATE} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fetched | ${{ steps.gmail.outputs.raw || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| After filter | ${{ steps.gmail.outputs.filtered || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Enriched | ${{ steps.gmail.outputs.enriched || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Zotero created | ${{ steps.gmail.outputs.zotero_created || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Zotero skipped | ${{ steps.gmail.outputs.zotero_skipped || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Zotero failed | ${{ steps.gmail.outputs.zotero_failed || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${{ steps.gmail.outputs.duration || '—' }}s |" >> $GITHUB_STEP_SUMMARY

      - name: Upload Gmail artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gmail-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ env.RUN_DIR }}
          if-no-files-found: warn
          retention-days: 14

      - name: Notify on failure
        if: failure() && github.event_name == 'schedule'
        run: |
          echo "::warning::Gmail workflow failed. Check the logs for details."

