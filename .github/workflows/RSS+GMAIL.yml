name: RSS+GMAIL

on:
  schedule:
    # Beijing 00:00 = UTC 16:00 (previous day)
    - cron: "0 16 * * *"
  workflow_dispatch: {}

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      RESEARCH_PROMPT: ${{ secrets.RESEARCH_PROMPT }}
      OPENALEX_API_KEY: ${{ secrets.OPENALEX_API_KEY }}
      POLITE_POOL_EMAIL: ${{ secrets.POLITE_POOL_EMAIL }}
      PAPER_FEEDDER_MCP_OPML: feeds/RSS_official.opml
      PAPER_FEEDDER_MCP_USER_AGENT: paper-feedder-mcp/2.0
      RSS_TIMEOUT: "30"
      RSS_MAX_CONCURRENT: "10"
      GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
      GMAIL_CREDENTIALS_JSON: ${{ secrets.GMAIL_CREDENTIALS_JSON }}
      GMAIL_SENDER_FILTER: ${{ secrets.GMAIL_SENDER_FILTER }}
      GMAIL_SENDER_MAP_JSON: ${{ secrets.GMAIL_SENDER_MAP_JSON }}
      GMAIL_TRASH_AFTER_PROCESS: "true"
      GMAIL_VERIFY_TRASH_AFTER_PROCESS: "true"
      GMAIL_VERIFY_TRASH_LIMIT: "50"
      GMAIL_TOKEN_FILE: feeds/token.json
      GMAIL_CREDENTIALS_FILE: feeds/credentials.json
      ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
      ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
      ZOTERO_LIBRARY_TYPE: user

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        id: setup_uv
        uses: astral-sh/setup-uv@v3
        with:
          # Pin to avoid intermittent failures when "latest" is unavailable.
          version: "0.5.21"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Compute dates
        shell: bash
        run: |
          echo "RUN_DATE=$(TZ=Asia/Shanghai date +%Y_%m_%d)" >> $GITHUB_ENV
          echo "SINCE_DATE=$(TZ=Asia/Shanghai date -d '15 days ago' +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Prepare output dir
        run: mkdir -p output

      - name: RSS pipeline (15 days)
        shell: bash
        run: |
          uv run paper-feedder-mcp fetch --source rss --since "$SINCE_DATE" --output output/rss_raw.json
          uv run paper-feedder-mcp filter --input output/rss_raw.json --output output/rss_filtered.json
          uv run paper-feedder-mcp filter --input output/rss_filtered.json --output output/rss_ai_filtered.json --ai
          uv run paper-feedder-mcp enrich --input output/rss_ai_filtered.json --output output/rss_enriched.json --source all --concurrency 5
          uv run paper-feedder-mcp export --input output/rss_enriched.json --output "output/${RUN_DATE}_RSS_ZOTERO.json" --format zotero

      - name: Gmail pipeline (15 days)
        shell: bash
        run: |
          uv run paper-feedder-mcp fetch --source gmail --since "$SINCE_DATE" --output output/gmail_raw.json
          uv run paper-feedder-mcp filter --input output/gmail_raw.json --output output/gmail_filtered.json
          uv run paper-feedder-mcp filter --input output/gmail_filtered.json --output output/gmail_ai_filtered.json --ai
          uv run paper-feedder-mcp enrich --input output/gmail_ai_filtered.json --output output/gmail_enriched.json --source all --concurrency 5
          uv run paper-feedder-mcp export --input output/gmail_enriched.json --output "output/${RUN_DATE}_GMAIL_ZOTERO.json" --format zotero

      - name: Clean output
        if: always()
        run: uv run paper-feedder-mcp delete --output-dir output
